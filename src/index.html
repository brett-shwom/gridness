<!DOCTYPE html>
<html>
<head>
<link rel='stylesheet' href='style.css' type='text/css'>
<script src='ractive.js'></script>
<script src='aggregate-functions.js'></script>
<script src='mock-data.js'></script>
</head>
<body>
<script type='text/template' id='template'>
  <div class='table-container'>
    <table>
      <thead>
        <tr>
          {{#columns}}
          <td>{{.}}</td>
          {{/columns}}
        </tr>
      </thead>
      <tbody>
      
        {{#Aggregate.groupBy(rows,"telephone")}}
        <tr style='background-color:green; cursor:pointer;' on-click='toggleGroupingVisibility'>
          <td>{{key}}</td>
        </tr>
        
        {{#!invisibleGroups[key]}}
        {{#data}}
        <!--{{#rowsInView}}-->
        <tr>
            {{#.}}
              <td>{{index}}</td>
              <td>{{name}}</td>
              <td>{{address}}</td>
              <td>{{city}}</td>
              <td>{{state}}</td> 
              <td>{{telephone}}</td>
            {{/.}}
        </tr>
        {{/data}}
        {{/!invisibleGroups[key]}}

        
        <tr><td>{{Aggregate.sum(.,"index")}}</td></tr>
        
        <!--{{/rowsInView}}-->
        {{/Aggregate.groupBy(rows,"telephone")}}
      </tbody>
    </table>
    <!--<div class='virtual-scroll-pane' on-scroll='scrolling' on-click='clicked'>
      <div class='virtual-content' style='height:{{virtualScrollPane.virtualContent.height}}px;'></div>
    </div>--><!--commented out while i figure out how to deal with sending click events through the virtual-scroll-pane-->
  </div>
</script>

<div id='container'></div>

<script data-scratchpad-rerender>

  var rowHeight = 20 //needs to be kept in sync with the css <tr> height
    , headerHeight = rowHeight
    , numberOfRowsToShow = 20

  var rows = MockData.generateRows()
  var columns = MockData.generateColumns()


  ractive = new Ractive({
    el  : document.querySelector('#container'),
    data : {
      Aggregate : Aggregate,
      rows : rows,
      invisibleGroups : {},
      rowsInView : [], //the call to sliceData() will initialize this
      columns : columns,
      virtualScrollPane : {
        virtualContent : { 
          height : rowHeight * rows.length + headerHeight
        }
      }
    }, 
    template : document.querySelector('#template').innerHTML
  })
  
  var virtualScrollPane = ractive.find('.virtual-scroll-pane')
  
  //http://stackoverflow.com/a/11252120
  function getElementScrollScale(domElement){
    return domElement.scrollTop / (domElement.scrollHeight - domElement.clientHeight);
  }
  
  ractive.on({
    scrolling : function () {
      var scrollScale = getElementScrollScale(virtualScrollPane)
        , start = scrollScale * (rows.length - numberOfRowsToShow) //do i need to round this?
        , end = start + numberOfRowsToShow
        
      sliceData(start,end)
    },
    toggleGroupingVisibility : function (event) {
      console.log('tt')
      var group = event.context

      ractive.toggle('invisibleGroups.' + group.key) //a bit of ractive keypath fun

    },
    clicked : function (event) {

     // Not working properly at the moment

     // var y = event.original.offsetY - ractive.find('.virtual-scroll-pane').scrollTop
     // var x = event.original.offsetX
     
     // var evt = document.createEvent('MouseEvent');
     //    evt.initMouseEvent('click', true, true, window, 0, screenX, screenY, x, y, true, false, false, true, 0, null);

     
     // ractive.find('.table-container table')
     
    }
  })
  
  
  function sliceData(start,end) {
    ractive.merge('rowsInView', rows.slice(start,end))
  }
  
  sliceData(0,numberOfRowsToShow)
  
</script>
</body>
</html>
